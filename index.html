<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BeeCheck ‚Äî Nota x S√∫mula</title>
<link rel="icon" href="abelha.png" type="image/png">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --coke-red:#E41C23;
  --coke-dark:#1A1A1A;
  --white:#ffffff;
  --radius:12px;
  font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
}
*{box-sizing:border-box}
body{margin:0;background:#fff;color:var(--coke-dark);-webkit-font-smoothing:antialiased;display:flex;flex-direction:column;min-height:100vh;}
.header{background:var(--coke-red);color:var(--white);padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
.brand{font-weight:700;font-size:18px}
.nav-tabs{display:flex;gap:12px;margin-top:10px;margin-bottom:10px}
.nav-tab{cursor:pointer;padding:8px 12px;border-radius:8px;background:#eee;font-weight:700}
.nav-tab.active{background:var(--coke-red);color:#fff}
.container{max-width:1200px;margin:0 auto;padding:16px;flex:1;}
.card{background:var(--white);border-radius:var(--radius);padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:18px}
.label{font-size:13px;color:#333;margin-bottom:6px;display:block}
input[type=file],input[type=text]{display:block}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.btn{background:var(--coke-red);color:var(--white);border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;box-shadow:0 8px 18px rgba(228,28,35,0.14)}
.btn.secondary{background:transparent;color:var(--coke-dark);border:1px solid #eee}
.btn.small{padding:8px 10px;font-size:14px}
.progress{font-size:13px;color:#333;margin-top:8px}
.table{width:100%;border-collapse:collapse;margin-top:12px;table-layout:fixed}
.table th,.table td{border:1px solid #e8e8e8;padding:8px;font-size:13px;text-align:left;vertical-align:middle;overflow:hidden}
.table th{background:#f9f9f9}
.table td.center{text-align:center}
.input-num{width:80px;padding:6px;border-radius:6px;border:1px solid #ddd}
.input-motorista{width:150px;padding:6px;border-radius:6px;border:1px solid #ddd}
.search{padding:8px;border-radius:8px;border:1px solid #ddd;width:320px}
.small{font-size:13px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.status-ok{color:green;font-weight:700}
.status-error{color:red;font-weight:700}
.icon-btn{background:transparent;border:0;cursor:pointer;font-size:14px}
.note{font-size:13px;color:#666;margin-top:8px}
canvas{max-width:100%;height:300px;margin-top:16px;}
footer.site-footer{ text-align:center; padding:12px; background:var(--coke-dark); color:var(--white); font-size:13px; margin-top:20px; border-radius:8px; }
@media (max-width:900px){ .row{flex-direction:column;align-items:stretch} .search{width:100%} .input-num,.input-motorista{width:100%} }
</style>
</head>
<body>

<header class="header">
  <div class="brand">BeeCheck ‚Äî Nota x S√∫mula</div>
  <div style="font-size:13px;color:#fff;opacity:0.95">üêù Colmeia Log√≠stica</div>
</header>

<div class="nav-tabs">
  <div class="nav-tab active" data-tab="conferencia">Confer√™ncia</div>
  <div class="nav-tab" data-tab="relatorios">Relat√≥rios</div>
</div>

<main class="container">

  <!-- Confer√™ncia -->
  <div id="conferencia" class="tab-content">

    <section class="card">
      <label class="label">Importar Banco (CSV ou Excel) ‚Äî colunas: C√≥digo,Produto</label>
      <input id="dbUpload" type="file" accept=".csv,.xlsx,.xls">
      <div class="note">Se tiver cabe√ßalho. Formato: <code>C√≥digo,Produto</code>.</div>
    </section>

    <section class="card">
      <div class="controls">
        <input id="produtoInput" placeholder="Procure produto..." list="prodList" class="search" aria-label="Produto">
        <datalist id="prodList"></datalist>
        <input id="quantInput" type="number" min="0" placeholder="Quantidade" class="input-num" aria-label="Quantidade">
        <input id="motoristaInput" type="text" placeholder="Motorista (opcional)" class="input-motorista">
        <button id="okNF" class="btn small">OK NF</button>
        <button id="okSumula" class="btn small">OK S√∫mula</button>
      </div>
      <div class="note">Digite o produto, selecione na lista, informe a quantidade, opcionalmente o motorista e clique em OK NF ou OK S√∫mula.</div>
    </section>

    <section class="card">
      <button id="conferirBtn" class="btn" disabled>Conferir</button>
      <button id="novaConfBtn" class="btn small secondary">Nova Confer√™ncia</button>
      <div id="progress" class="progress"></div>
    </section>

    <section class="card">
      <h3>Lista de Produtos para Confer√™ncia</h3>
      <table class="table" id="prodTable">
        <thead>
          <tr>
            <th style="width:10%">C√≥digo</th>
            <th style="width:40%">Produto</th>
            <th style="width:10%" class="center">NF</th>
            <th style="width:10%" class="center">S√∫mula</th>
            <th style="width:15%" class="center">Motorista(s)</th>
            <th style="width:10%" class="center">Status</th>
            <th style="width:10%" class="center">Diverg√™ncia</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </div>

  <!-- Relat√≥rios -->
  <div id="relatorios" class="tab-content" style="display:none">
    <section class="card">
      <h3>Gr√°fico de Retornos por Motorista</h3>
      <canvas id="graficoMotoristas"></canvas>
    </section>
  </div>

</main>

<footer class="site-footer">
  ¬© 2025 BeeCheck ‚Äî Todos os direitos reservados √† Colmeia Log√≠stica üêù
</footer>

<script>
/* --- Navega√ß√£o de abas --- */
document.querySelectorAll('.nav-tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
    document.getElementById(tab.dataset.tab).style.display='block';
    if(tab.dataset.tab==='relatorios') renderGrafico();
  });
});

/* --- Banco e confer√™ncia --- */
let bancoProdutos = [];
let nfList = {};
let sumulaList = {};
let motoristaList = {}; // c√≥digo ‚Üí [{nome, quantidade}]
const STORAGE_KEY = 'conferente_banco_v7';

const dbUpload = document.getElementById('dbUpload');
const produtoInput = document.getElementById('produtoInput');
const prodList = document.getElementById('prodList');
const quantInput = document.getElementById('quantInput');
const motoristaInput = document.getElementById('motoristaInput');
const okNF = document.getElementById('okNF');
const okSumula = document.getElementById('okSumula');
const conferirBtn = document.getElementById('conferirBtn');
const novaConfBtn = document.getElementById('novaConfBtn');
const prodTableBody = document.querySelector('#prodTable tbody');
const progress = document.getElementById('progress');

function setProgress(msg){ progress.innerText=msg||''; }
function escapeHtml(text){ return text==null?'':String(text).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({banco:bancoProdutos,nf:nfList,sumula:sumulaList,motorista:motoristaList})); }

/* --- Parse CSV/XLSX --- */
function guessCodeName(tokens){
  const a=tokens[0]?tokens[0].trim():'', b=tokens[1]?tokens[1].trim():'';
  if(/produto|nome/i.test(a)||/produto|nome/i.test(b)) return null;
  const aDigits=(a.match(/\d/g)||[]).length, bDigits=(b.match(/\d/g)||[]).length;
  if(aDigits>bDigits) return {code:a,name:b};
  if(bDigits>aDigits) return {code:b,name:a};
  return a.length<=b.length?{code:a,name:b}:{code:b,name:a};
}
async function parseFile(file){
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload=(e)=>{
      let lines=[];
      if(file.name.toLowerCase().endsWith('.csv')){
        lines=e.target.result.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
      } else {
        try{
          const workbook = XLSX.read(e.target.result,{type:'array'});
          const sheetName = workbook.SheetNames[0];
          const csv = XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName]);
          lines = csv.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
        } catch{ setProgress('Erro ao ler Excel'); resolve([]); return; }
      }
      const items=[];
      lines.forEach(l=>{
        const tokens=l.split(/[,;\t]/).map(t=>t.trim()).filter(t=>t);
        if(tokens.length<2) return;
        const g=guessCodeName(tokens);
        if(!g) return;
        items.push({codigo:g.code,nome:g.name});
      });
      resolve(items);
    };
    if(file.name.toLowerCase().endsWith('.csv')) reader.readAsText(file,'UTF-8');
    else reader.readAsArrayBuffer(file);
  });
}

/* --- Render --- */
function renderDatalist(){
  prodList.innerHTML='';
  bancoProdutos.forEach(p=>{
    const opt=document.createElement('option');
    opt.value=`${p.nome} (${p.codigo})`;
    prodList.appendChild(opt);
  });
}
function renderTable(conferido=false){
  prodTableBody.innerHTML='';
  const codigos = new Set([...Object.keys(nfList), ...Object.keys(sumulaList)]);
  bancoProdutos.forEach(p=>{
    if(!codigos.has(p.codigo)) return;
    const nf = nfList[p.codigo]||0;
    const sum = sumulaList[p.codigo]||0;
    const diverg = Math.abs(nf-sum);

    const motoristas = (motoristaList[p.codigo]||[])
      .map(m=>`${escapeHtml(m.nome)} (${m.quantidade})`)
      .join('<br>');

    let statusText='', statusClass='';
    if(conferido){
      if(nf===sum){ statusText='Conforme'; statusClass='status-ok'; }
      else { statusText='N√£o Conforme'; statusClass='status-error'; }
    }
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHtml(p.codigo)}</td>
      <td>${escapeHtml(p.nome)}</td>
      <td class="center">${nf}</td>
      <td class="center">${sum}</td>
      <td class="center">${motoristas}</td>
      <td class="center"><span class="${statusClass}">${statusText}</span></td>
      <td class="center">${conferido?diverg:''}</td>
    `;
    prodTableBody.appendChild(tr);
  });
}

/* --- Eventos --- */
dbUpload.addEventListener('change', async ()=>{
  if(!dbUpload.files[0]) return;
  setProgress('Lendo arquivo...');
  const items = await parseFile(dbUpload.files[0]);
  if(!items.length){ setProgress('Nenhum produto reconhecido'); return; }
  bancoProdutos=items;
  saveLocal();
  renderDatalist();
  setProgress(`Banco carregado (${bancoProdutos.length} produtos)`);
});

function adicionarProduto(lista){
  const val = Number(quantInput.value);
  const sel = produtoInput.value.trim();
  const motorista = motoristaInput.value.trim();
  if(!val||!sel){ alert('Selecione produto e quantidade'); return; }
  const match=bancoProdutos.find(p=>sel.includes(p.nome));
  if(!match){ alert('Produto n√£o encontrado'); return; }

  lista[match.codigo]=(lista[match.codigo]||0)+val;

  if(motorista){
    if(!motoristaList[match.codigo]) motoristaList[match.codigo]=[];
    motoristaList[match.codigo].push({nome:motorista,quantidade:val});
  }

  produtoInput.value=''; quantInput.value=''; motoristaInput.value='';
  conferirBtn.disabled=Object.keys(nfList).length===0||Object.keys(sumulaList).length===0;
  renderTable();
  setProgress(`Produto "${match.nome}" adicionado`);
  saveLocal();
}

okNF.addEventListener('click', ()=>adicionarProduto(nfList));
okSumula.addEventListener('click', ()=>adicionarProduto(sumulaList));

conferirBtn.addEventListener('click', ()=>{
  renderTable(true);
  setProgress('Confer√™ncia conclu√≠da');
});

novaConfBtn.addEventListener('click', ()=>{
  if(!confirm('Deseja iniciar nova confer√™ncia?')) return;
  nfList={}; sumulaList={}; motoristaList={};
  conferirBtn.disabled=true;
  renderTable();
  setProgress('Nova confer√™ncia iniciada');
  saveLocal();
});

/* --- Inicializa√ß√£o --- */
const saved = localStorage.getItem(STORAGE_KEY);
if(saved){
  const parsed=JSON.parse(saved);
  bancoProdutos=parsed.banco||[];
  nfList=parsed.nf||{};
  sumulaList=parsed.sumula||{};
  motoristaList=parsed.motorista||{};
  renderDatalist();
  renderTable();
  conferirBtn.disabled=Object.keys(nfList).length===0||Object.keys(sumulaList).length===0;
  setProgress(`Banco carregado (${bancoProdutos.length} produtos)`);
}

/* --- Gr√°fico de motoristas --- */
function renderGrafico(){
  const ctx = document.getElementById('graficoMotoristas').getContext('2d');
  const contagemMotoristas={};

  Object.values(motoristaList).forEach(lista=>{
    lista.forEach(m=>{
      contagemMotoristas[m.nome]=(contagemMotoristas[m.nome]||0)+m.quantidade;
    });
  });

  const labels = Object.keys(contagemMotoristas);
  const data = Object.values(contagemMotoristas);
  if(window.chartMotoristas) window.chartMotoristas.destroy();
  window.chartMotoristas = new Chart(ctx,{
    type:'bar',
    data:{
      labels,
      datasets:[{
        label:'Retornos por motorista',
        data,
        backgroundColor:'rgba(228,28,35,0.6)',
        borderColor:'rgba(228,28,35,1)',
        borderWidth:1
      }]
    },
    options:{ scales:{ y:{beginAtZero:true,precision:0} } }
  });
}
</script>

</body>
</html>
