<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BeeCheck ‚Äî Nota x S√∫mula</title>

<!-- Favicon -->
<link rel="icon" href="abelha.png" type="image/png">

<!-- SEO B√°sico -->
<meta name="description" content="BeeCheck üêù ‚Äî sistema online para confer√™ncia r√°pida e precisa entre Nota Fiscal e S√∫mula. Desenvolvido pela Colmeia Log√≠stica.">
<meta name="keywords" content="BeeCheck, log√≠stica, confer√™ncia, nota fiscal, s√∫mula, controle de estoque, auditoria">
<meta name="author" content="Colmeia Log√≠stica">

<!-- Open Graph (Facebook, LinkedIn, WhatsApp) -->
<meta property="og:title" content="BeeCheck ‚Äî Nota x S√∫mula">
<meta property="og:description" content="Confer√™ncia r√°pida e precisa entre Nota Fiscal e S√∫mula. Experimente o BeeCheck üêù">
<meta property="og:type" content="website">
<meta property="og:url" content="https://seusiteaqui.com"> <!-- troque pelo link real do seu site -->
<meta property="og:image" content="abelha.png"> <!-- imagem usada no compartilhamento -->

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="BeeCheck ‚Äî Nota x S√∫mula">
<meta name="twitter:description" content="Sistema online de confer√™ncia de NF x S√∫mula com visual Coca-Cola üêù">
<meta name="twitter:image" content="abelha.png">

<!-- Biblioteca XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Estilos -->
<style>
:root{
  --coke-red:#E41C23;
  --coke-dark:#1A1A1A;
  --white:#ffffff;
  --radius:12px;
  font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
}
*{box-sizing:border-box}

/* --- layout flex para empurrar footer pro fim --- */
html,body{
  height:100%;
  margin:0;
  display:flex;
  flex-direction:column;
  background:#fff;
  color:var(--coke-dark);
  -webkit-font-smoothing:antialiased;
}

.header{background:var(--coke-red);color:var(--white);padding:18px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
.brand{font-weight:700;font-size:18px}
.container{max-width:1200px;margin:20px auto;padding:16px;flex:1;} /* flex:1 empurra footer para baixo */
.card{background:var(--white);border-radius:var(--radius);padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:18px}
.label{font-size:13px;color:#333;margin-bottom:6px;display:block}
input[type=file]{display:block}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.btn{background:var(--coke-red);color:var(--white);border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;box-shadow:0 8px 18px rgba(228,28,35,0.14)}
.btn.secondary{background:transparent;color:var(--coke-dark);border:1px solid #eee}
.btn.small{padding:8px 10px;font-size:14px}
.progress{font-size:13px;color:#333;margin-top:8px}
.table{width:100%;border-collapse:collapse;margin-top:12px;table-layout:fixed}
.table th,.table td{border:1px solid #e8e8e8;padding:8px;font-size:13px;text-align:left;vertical-align:middle;overflow:hidden}
.table th{background:#f9f9f9}
.table td.center{text-align:center}
.input-num{width:80px;padding:6px;border-radius:6px;border:1px solid #ddd}
.search{padding:8px;border-radius:8px;border:1px solid #ddd;width:320px}
.small{font-size:13px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.status-ok{color:green;font-weight:700}
.status-error{color:red;font-weight:700}
.icon-btn{background:transparent;border:0;cursor:pointer;font-size:14px}
.note{font-size:13px;color:#666;margin-top:8px}
footer.site-footer{ text-align:center; padding:12px; background:var(--coke-dark); color:var(--white); font-size:13px; margin-top:20px; border-radius:8px; }
@media (max-width:900px){ .row{flex-direction:column;align-items:stretch} .search{width:100%} .input-num{width:68px} }
</style>
</head>

<body>
<header class="header">
  <div class="brand">BeeCheck ‚Äî Nota x S√∫mula, conferente online</div>
  <div style="font-size:13px;color:#fff;opacity:0.95">üêù Colmeia Log√≠stica</div>
</header>

<main class="container">

  <!-- Importa√ß√£o banco -->
  <section class="card">
    <label class="label">Importar Banco (CSV ou Excel) ‚Äî colunas: C√≥digo,Produto</label>
    <input id="dbUpload" type="file" accept=".csv,.xlsx,.xls">
    <div class="note">Se tiver cabe√ßalho. Formato: <code>C√≥digo,Produto</code>.</div>
  </section>

  <!-- Adicionar produtos NF/S√∫mula -->
  <section class="card">
    <div class="controls">
      <input id="produtoInput" placeholder="Procure produto..." list="prodList" class="search" aria-label="Produto">
      <datalist id="prodList"></datalist>
      <input id="quantInput" type="number" min="0" placeholder="Quantidade" class="input-num" aria-label="Quantidade">
      <button id="okNF" class="btn small">OK NF</button>
      <button id="okSumula" class="btn small">OK S√∫mula</button>
    </div>
    <div class="note">Digite o produto, selecione na lista (ex.: Produto X (123)), informe a quantidade e clique em OK NF ou OK S√∫mula.</div>
  </section>

  <!-- Confer√™ncia -->
  <section class="card">
    <button id="conferirBtn" class="btn" disabled>Conferir</button>
    <button id="novaConfBtn" class="btn small secondary">Nova Confer√™ncia</button>
    <div id="progress" class="progress"></div>
  </section>

  <!-- Tabela de resultados -->
  <section class="card">
    <h3>Lista de Produtos para Confer√™ncia</h3>
    <table class="table" id="prodTable">
      <thead>
        <tr>
          <th style="width:10%">C√≥digo</th>
          <th style="width:50%">Produto</th>
          <th style="width:10%" class="center">NF</th>
          <th style="width:10%" class="center">S√∫mula</th>
          <th style="width:10%" class="center">Status</th>
          <th style="width:10%" class="center">Diverg√™ncia</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

</main>

<footer class="site-footer">
  ¬© 2025 BeeCheck ‚Äî Todos os direitos reservados √† Colmeia Log√≠stica üêù
</footer>

<!-- Script principal -->
<script>
/* Estado */
let bancoProdutos = []; // array {codigo,nome}
let nfList = {}; // mapa codigo -> quantidade
let sumulaList = {}; // mapa codigo -> quantidade
const STORAGE_KEY = 'conferente_banco_v5';

/* Elementos DOM */
const dbUpload = document.getElementById('dbUpload');
const produtoInput = document.getElementById('produtoInput');
const prodList = document.getElementById('prodList');
const quantInput = document.getElementById('quantInput');
const okNF = document.getElementById('okNF');
const okSumula = document.getElementById('okSumula');
const conferirBtn = document.getElementById('conferirBtn');
const novaConfBtn = document.getElementById('novaConfBtn');
const prodTableBody = document.querySelector('#prodTable tbody');
const progress = document.getElementById('progress');

function setProgress(msg){ progress.innerText = msg || ''; }
function escapeHtml(text){ return text==null ? '' : String(text).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* Salvar/Carregar localStorage */
function saveLocal(){
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify({banco:bancoProdutos,nf:nfList,sumula:sumulaList}));
  }catch(e){ console.error(e); }
}
function loadLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const parsed = JSON.parse(raw);
    bancoProdutos = parsed.banco || [];
    nfList = parsed.nf || {};
    sumulaList = parsed.sumula || {};
  } catch(e){ console.error(e); }
}

/* Heur√≠stica para reconhecer c√≥digo/nome do CSV/XLSX */
function guessCodeName(tokens){
  const a = tokens[0] ? tokens[0].trim() : '';
  const b = tokens[1] ? tokens[1].trim() : '';
  if(/produto|nome|descri|descri√ß√£o/i.test(a) || /produto|nome|descri|descri√ß√£o/i.test(b)) return null;
  const aDigits = (a.match(/\d/g)||[]).length;
  const bDigits = (b.match(/\d/g)||[]).length;
  if(aDigits > bDigits) return {code:a, name:b};
  if(bDigits > aDigits) return {code:b, name:a};
  return a.length <= b.length ? {code:a,name:b} : {code:b,name:a};
}

/* Ler arquivo CSV / XLSX */
async function parseFile(file){
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = (e) => {
      let lines = [];
      if(file.name.toLowerCase().endsWith('.csv')){
        lines = e.target.result.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
      } else {
        try{
          const workbook = XLSX.read(e.target.result, {type:'array'});
          const sheetName = workbook.SheetNames[0];
          const csv = XLSX.utils.sheet_to_csv(workbook.Sheets[sheetName]);
          lines = csv.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
        } catch(err){
          console.error(err);
          setProgress('Erro ao ler arquivo Excel');
          resolve([]);
          return;
        }
      }
      const items = [];
      lines.forEach(l=>{
        const tokens = l.split(/[,;\t]/).map(t=>t.trim()).filter(t=>t);
        if(tokens.length < 2) return;
        const g = guessCodeName(tokens);
        if(!g) return;
        items.push({codigo: g.code, nome: g.name});
      });
      resolve(items);
    };
    if(file.name.toLowerCase().endsWith('.csv')) reader.readAsText(file,'UTF-8');
    else reader.readAsArrayBuffer(file);
  });
}

/* Render datalist (autocompletar) */
function renderDatalist(){
  prodList.innerHTML = '';
  bancoProdutos.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = `${p.nome} (${p.codigo})`;
    prodList.appendChild(opt);
  });
}

/* Render tabela: s√≥ mostra itens que foram adicionados (NF ou s√∫mula) */
function renderTable(conferido=false){
  prodTableBody.innerHTML = '';
  const codigos = new Set([...Object.keys(nfList), ...Object.keys(sumulaList)]);
  bancoProdutos.forEach(p=>{
    if(!codigos.has(p.codigo)) return;
    const nf = Number(nfList[p.codigo] || 0);
    const sum = Number(sumulaList[p.codigo] || 0);
    const diverg = Math.abs(nf - sum);
    let statusText = '', statusClass = '';
    if(conferido){
      if(nf === sum){ statusText = 'Conforme'; statusClass = 'status-ok'; }
      else { statusText = 'N√£o Conforme'; statusClass = 'status-error'; }
    }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(p.codigo)}</td>
      <td>${escapeHtml(p.nome)}</td>
      <td class="center">${nf}</td>
      <td class="center">${sum}</td>
      <td class="center"><span class="${statusClass}">${statusText}</span></td>
      <td class="center">${conferido ? diverg : ''}</td>
    `;
    prodTableBody.appendChild(tr);
  });
}

/* Extrair c√≥digo a partir do valor do input (formato: Nome do Produto (C√ìDIGO)) */
function getCodeFromSelection(sel){
  if(!sel) return null;
  const m = sel.match(/\(([^()]+)\)\s*$/);
  if(m && m[1]) return m[1];
  // fallback: procurar por nome parcial
  const found = bancoProdutos.find(p => sel === p.nome || sel.includes(p.nome));
  return found ? found.codigo : null;
}

/* Atualiza estado do bot√£o Conferir (ativo apenas se ambos tiverem pelo menos um item) */
function updateConferirState(){
  const hasNF = Object.keys(nfList).length > 0;
  const hasSumula = Object.keys(sumulaList).length > 0;
  conferirBtn.disabled = !(hasNF && hasSumula);
}

/* --- Eventos --- */
dbUpload.addEventListener('change', async ()=>{
  if(!dbUpload.files[0]) return;
  setProgress('Lendo arquivo...');
  const items = await parseFile(dbUpload.files[0]);
  if(!items.length){ setProgress('Nenhum produto reconhecido'); return; }

  // preservar quantidades existentes para c√≥digos que permane√ßam
  const newBanco = items;
  const preservedNF = {};
  const preservedSum = {};
  newBanco.forEach(p=>{
    if(nfList[p.codigo]) preservedNF[p.codigo] = nfList[p.codigo];
    if(sumulaList[p.codigo]) preservedSum[p.codigo] = sumulaList[p.codigo];
  });
  bancoProdutos = newBanco;
  nfList = preservedNF;
  sumulaList = preservedSum;

  saveLocal();
  renderDatalist();
  renderTable();
  updateConferirState();
  setProgress(`Banco carregado (${bancoProdutos.length} produtos)`);
});

/* Adicionar √† NF (soma valores repetidos) */
okNF.addEventListener('click', ()=>{
  const val = Number(quantInput.value || 0);
  const sel = produtoInput.value.trim();
  if(!val || !sel){ alert('Selecione produto e quantidade'); return; }

  const code = getCodeFromSelection(sel);
  let match = bancoProdutos.find(p => p.codigo === code);
  if(!match){
    // tentativa por nome
    match = bancoProdutos.find(p => sel.includes(p.nome));
    if(!match){ alert('Produto n√£o encontrado no banco'); return; }
  }
  const codigo = match.codigo;
  nfList[codigo] = (Number(nfList[codigo]||0) + val);
  produtoInput.value = '';
  quantInput.value = '';
  saveLocal();
  renderTable();
  updateConferirState();
  setProgress(`Produto "${match.nome}" adicionado √† NF (total: ${nfList[codigo]})`);
});

/* Adicionar √† S√∫mula (soma valores repetidos) */
okSumula.addEventListener('click', ()=>{
  const val = Number(quantInput.value || 0);
  const sel = produtoInput.value.trim();
  if(!val || !sel){ alert('Selecione produto e quantidade'); return; }

  const code = getCodeFromSelection(sel);
  let match = bancoProdutos.find(p => p.codigo === code);
  if(!match){
    match = bancoProdutos.find(p => sel.includes(p.nome));
    if(!match){ alert('Produto n√£o encontrado no banco'); return; }
  }
  const codigo = match.codigo;
  sumulaList[codigo] = (Number(sumulaList[codigo]||0) + val);
  produtoInput.value = '';
  quantInput.value = '';
  saveLocal();
  renderTable();
  updateConferirState();
  setProgress(`Produto "${match.nome}" adicionado √† S√∫mula (total: ${sumulaList[codigo]})`);
});

/* Conferir: mostra Conforme/N√£o Conforme e diverg√™ncias */
conferirBtn.addEventListener('click', ()=>{
  renderTable(true);
  // resumo r√°pido
  const codigos = [...new Set([...Object.keys(nfList), ...Object.keys(sumulaList)])];
  let divergencias = 0;
  codigos.forEach(c => {
    const a = Number(nfList[c]||0), b = Number(sumulaList[c]||0);
    if(a !== b) divergencias++;
  });
  setProgress(divergencias === 0 ? 'Confer√™ncia conclu√≠da ‚Äî Todos conforme ‚úÖ' : `Confer√™ncia conclu√≠da ‚Äî ${divergencias} diverg√™ncia(s) encontrada(s) ‚ùå`);
});

/* Nova confer√™ncia (limpa s√≥ as listas, n√£o o banco) */
novaConfBtn.addEventListener('click', ()=>{
  if(!confirm('Deseja iniciar nova confer√™ncia? Isso limpar√° apenas as quantidades de NF e S√∫mula, mantendo o banco de produtos.')) return;
  nfList = {};
  sumulaList = {};
  saveLocal();
  renderTable();
  updateConferirState();
  setProgress('Nova confer√™ncia iniciada');
});

/* Inicializa√ß√£o: carregar localStorage e renderizar */
loadLocal();
renderDatalist();
renderTable();
updateConferirState();
if(bancoProdutos.length) setProgress(`Banco carregado (${bancoProdutos.length} produtos)`);
else setProgress('Nenhum banco carregado. Importe uma planilha.');

</script>
</body>
</html>

