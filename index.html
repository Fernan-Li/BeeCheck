<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BeeCheck ‚Äî Nota x S√∫mula</title>

<link rel="icon" href="abelha.png" type="image/png">
<meta name="description" content="Confer√™ncia r√°pida e precisa entre Nota Fiscal e S√∫mula. Experimente o BeeCheck üêù">

<!-- Biblioteca XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --coke-red:#E41C23;
  --coke-dark:#1A1A1A;
  --white:#ffffff;
  --radius:12px;
  font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
}
*{box-sizing:border-box}
body{margin:0;background:#fff;color:var(--coke-dark);-webkit-font-smoothing:antialiased;display:flex;flex-direction:column;min-height:100vh;}
.header{background:var(--coke-red);color:var(--white);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08);}
.brand{font-weight:700;font-size:18px}
.user-info{display:flex;align-items:center;gap:6px;font-size:13px;position:relative;}
.user-info button{margin-left:6px;padding:4px 8px;font-size:12px;border-radius:8px;border:none;background:#fff;color:var(--coke-red);cursor:pointer}
.container{max-width:1200px;margin:20px auto;padding:16px;flex:1;}
.card{background:var(--white);border-radius:var(--radius);padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:18px}
.label{font-size:13px;color:#333;margin-bottom:6px;display:block}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.btn{background:var(--coke-red);color:var(--white);border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;box-shadow:0 8px 18px rgba(228,28,35,0.14)}
.btn.secondary{background:transparent;color:var(--coke-dark);border:1px solid #eee}
.btn.small{padding:8px 10px;font-size:14px}
.progress{font-size:13px;color:#333;margin-top:8px}
.table{width:100%;border-collapse:collapse;margin-top:12px;table-layout:fixed}
.table th,.table td{border:1px solid #e8e8e8;padding:8px;font-size:13px;text-align:left;vertical-align:middle;overflow:hidden}
.table th{background:#f9f9f9}
.table td.center{text-align:center}
.input-num{width:80px;padding:6px;border-radius:6px;border:1px solid #ddd}
.search{padding:8px;border-radius:8px;border:1px solid #ddd;width:320px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.status-ok{color:green;font-weight:700}
.status-error{color:red;font-weight:700}
.note{font-size:13px;color:#666;margin-top:8px}
footer.site-footer{ text-align:center; padding:12px; background:var(--coke-dark); color:var(--white); font-size:13px; margin-top:20px; border-radius:8px; }

.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:1000;}
.modal-card{background:white;padding:20px;border-radius:12px;max-width:420px;width:94%;}

.tabs{display:flex;gap:12px;margin-bottom:12px}
.tab-btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700;background:#eee}
.tab-btn.active{background:var(--coke-red);color:#fff}
.tab-content{display:none}
.tab-content.active{display:block}

@media (max-width:900px){ .search{width:100%} .input-num{width:68px} .controls{flex-direction:column;align-items:stretch} .user-info span{display:none} }
</style>
</head>
<body>

<header class="header">
  <div class="brand">BeeCheck ‚Äî Nota x S√∫mula</div>
  <div class="user-info" title="Perfil">
    <img id="userAvatar" src="https://fernanda-li.github.io/CONFERENTE_ONLINE/abelha.png" width="36" height="36" style="border-radius:50%;object-fit:cover">
    <span id="userName">Usu√°rio</span>
    <button id="editProfileBtn" aria-label="Editar perfil">Alterar Perfil</button>
    <button id="logoutBtn" aria-label="Sair" title="Sair">Sair</button>
  </div>
</header>

<main class="container">

  <!-- Abas -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="tabConferencia">Confer√™ncia</button>
    <button class="tab-btn" data-tab="tabHistorico">Hist√≥rico</button>
  </div>

  <!-- Aba Confer√™ncia -->
  <div id="tabConferencia" class="tab-content active">
    <!-- Importa√ß√£o banco -->
    <section class="card">
      <label class="label">Importar Banco (CSV ou Excel) ‚Äî colunas: C√≥digo,Produto</label>
      <input id="dbUpload" type="file" accept=".csv,.xlsx,.xls">
      <div class="note">Formato: <code>C√≥digo,Produto</code>. (Com ou sem cabe√ßalho)</div>
    </section>

    <!-- Adicionar produtos NF/S√∫mula -->
    <section class="card">
      <div class="controls">
        <input id="produtoInput" placeholder="Procure produto..." list="prodList" class="search" aria-label="Produto">
        <datalist id="prodList"></datalist>
        <input id="quantInput" type="number" min="1" placeholder="Quantidade" class="input-num" aria-label="Quantidade">
        <button id="okNF" class="btn small">OK NF</button>
        <button id="okSumula" class="btn small">OK S√∫mula</button>
      </div>
      <div class="note">Digite/cole o produto, escolha na lista e informe a quantidade.</div>
    </section>

    <!-- Confer√™ncia -->
    <section class="card">
      <button id="conferirBtn" class="btn" disabled>Conferir</button>
      <button id="novaConfBtn" class="btn small secondary">Nova Confer√™ncia</button>
      <div id="progress" class="progress"></div>
    </section>

    <!-- Tabela de resultados -->
    <section class="card">
      <h3>Lista de Produtos para Confer√™ncia</h3>
      <table class="table" id="prodTable">
        <thead>
          <tr>
            <th style="width:10%">C√≥digo</th>
            <th style="width:50%">Produto</th>
            <th style="width:10%" class="center">NF</th>
            <th style="width:10%" class="center">S√∫mula</th>
            <th style="width:10%" class="center">Status</th>
            <th style="width:10%" class="center">Qtd Conferida</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <!-- Aba Hist√≥rico -->
  <div id="tabHistorico" class="tab-content">
    <section class="card">
      <h3>Hist√≥rico de Confer√™ncias</h3>
      <table class="table" id="historyTable">
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Usu√°rio</th>
            <th>Total NF</th>
            <th>Total S√∫mula</th>
            <th>Total Diverg√™ncias</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

</main>

<footer class="site-footer">
  ¬© 2025 BeeCheck ‚Äî Todos os direitos reservados √† Colmeia Log√≠stica üêù
</footer>

<!-- Modal de configura√ß√£o do perfil -->
<div id="userModal" class="modal-overlay" style="display:none;">
  <div class="modal-card">
    <h2>Bem-vindo ao BeeCheck üêù</h2>
    <p>Configure seu usu√°rio para come√ßar:</p>
    <input id="inputNomeModal" placeholder="Nome do usu√°rio" class="search" style="width:100%;margin:10px 0;">
    <input id="inputCargoModal" placeholder="Cargo" class="search" style="width:100%;margin-bottom:10px;">
    <input id="inputAvatarModal" type="file" accept="image/*" style="margin-bottom:12px;">
    <button id="btnSalvarModal" class="btn" style="width:100%;">Salvar e Come√ßar</button>
  </div>
</div>

<script>
// Dados e chaves
let bancoProdutos = [], nfList = {}, sumulaList = {}, history = [];
let currentUser = { nome:'Usu√°rio', cargo:'', avatar:'https://fernanda-li.github.io/CONFERENTE_ONLINE/abelha.png' };
const STORAGE_KEY = 'conferente_banco_v5', HISTORY_KEY = 'conferente_history_v5';

// Elementos
const dbUpload = document.getElementById('dbUpload');
const produtoInput = document.getElementById('produtoInput');
const prodList = document.getElementById('prodList');
const quantInput = document.getElementById('quantInput');
const okNF = document.getElementById('okNF');
const okSumula = document.getElementById('okSumula');
const conferirBtn = document.getElementById('conferirBtn');
const novaConfBtn = document.getElementById('novaConfBtn');
const prodTableBody = document.querySelector('#prodTable tbody');
const historyTableBody = document.querySelector('#historyTable tbody');
const progress = document.getElementById('progress');
const userNameEl = document.getElementById('userName');
const userAvatarEl = document.getElementById('userAvatar');
const editProfileBtn = document.getElementById('editProfileBtn');
const logoutBtn = document.getElementById('logoutBtn');

// Modal elements
const userModal = document.getElementById('userModal');
const inputNomeModal = document.getElementById('inputNomeModal');
const inputCargoModal = document.getElementById('inputCargoModal');
const inputAvatarModal = document.getElementById('inputAvatarModal');
const btnSalvarModal = document.getElementById('btnSalvarModal');

// Helpers
function setProgress(msg){ progress.innerText = msg || ''; }
function escapeHtml(text){ return text==null ? '' : String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function saveLocal(){
  const store = { banco: bancoProdutos, nf: nfList, sumula: sumulaList, currentUser };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
  localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
}

// Advinha colunas C√≥digo/Produto
function guessCodeName(tokens){
  const a = tokens[0]?tokens[0].trim():'', b = tokens[1]?tokens[1].trim():'';
  if(/produto|nome/i.test(a) || /produto|nome/i.test(b)) return null;
  const aDigits = (a.match(/\d/g)||[]).length, bDigits = (b.match(/\d/g)||[]).length;
  if(aDigits > bDigits) return { code: a, name: b };
  if(bDigits > aDigits) return { code: b, name: a };
  return a.length <= b.length ? { code: a, name: b } : { code: b, name: a };
}

// Parse CSV / XLSX
async function parseFile(file){
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = (e) => {
      let lines = [];
      if(file.name.toLowerCase().endsWith('.csv')){
        lines = e.target.result.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
      } else {
        try {
          const workbook = XLSX.read(e.target.result, { type: 'array' });
          const sheet = workbook.SheetNames[0];
          const csv = XLSX.utils.sheet_to_csv(workbook.Sheets[sheet]);
          lines = csv.split(/\r?\n/).map(l=>l.trim()).filter(l=>l);
        } catch(err){
          setProgress('Erro ao ler Excel');
          resolve([]);
          return;
        }
      }
      const items = [];
      lines.forEach(l => {
        const tokens = l.split(/[,;\t]/).map(t=>t.trim()).filter(t=>t);
        if(tokens.length < 2) return;
        const g = guessCodeName(tokens);
        if(!g) return;
        items.push({ codigo: g.code, nome: g.name });
      });
      resolve(items);
    };
    if(file.name.toLowerCase().endsWith('.csv')) reader.readAsText(file, 'UTF-8');
    else reader.readAsArrayBuffer(file);
  });
}

// Render datalist (autocompletar)
function renderDatalist(){
  prodList.innerHTML = '';
  bancoProdutos.forEach(p => {
    const opt = document.createElement('option');
    opt.value = `${p.nome} (${p.codigo})`;
    prodList.appendChild(opt);
  });
}

// Render tabela de produtos
function renderTable(conferido = false){
  prodTableBody.innerHTML = '';
  const codigos = new Set([...Object.keys(nfList), ...Object.keys(sumulaList)]);
  bancoProdutos.forEach(p => {
    if(!codigos.has(p.codigo)) return;
    const nf = nfList[p.codigo] || 0;
    const sum = sumulaList[p.codigo] || 0;
    const diverg = Math.abs(nf - sum);
    let statusText = '', statusClass = '';
    if(conferido){ statusText = (nf === sum) ? 'Conforme' : 'N√£o Conforme'; statusClass = (nf === sum) ? 'status-ok' : 'status-error'; }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(p.codigo)}</td>
      <td>${escapeHtml(p.nome)}</td>
      <td class="center">${nf}</td>
      <td class="center">${sum}</td>
      <td class="center"><span class="${statusClass}">${statusText}</span></td>
      <td class="center">${nf + sum}</td>
    `;
    prodTableBody.appendChild(tr);
  });
}

// Render hist√≥rico
function renderHistory(){
  historyTableBody.innerHTML = '';
  history.forEach(h => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${h.data}</td>
      <td>${escapeHtml(h.usuario)}</td>
      <td>${h.totalNF}</td>
      <td>${h.totalSum}</td>
      <td>${h.totalDiv}</td>
    `;
    historyTableBody.appendChild(tr);
  });
}

// Eventos

// Salvar usu√°rio via modal
btnSalvarModal.addEventListener('click', ()=> {
  const nome = inputNomeModal.value.trim() || 'Usu√°rio';
  const cargo = inputCargoModal.value.trim() || '';
  if(inputAvatarModal.files[0]){
    const reader = new FileReader();
    reader.onload = e => {
      currentUser = { nome, cargo, avatar: e.target.result };
      userNameEl.textContent = nome;
      userAvatarEl.src = e.target.result;
      inputNomeModal.value = ''; inputCargoModal.value = ''; inputAvatarModal.value = '';
      saveLocal();
      userModal.style.display = 'none';
      setProgress('Perfil salvo');
      // habilita bot√£o conferir caso j√° existam itens
      conferirBtn.disabled = (Object.keys(nfList).length === 0) || (Object.keys(sumulaList).length === 0);
    };
    reader.readAsDataURL(inputAvatarModal.files[0]);
  } else {
    currentUser = { nome, cargo, avatar: currentUser.avatar };
    userNameEl.textContent = nome;
    saveLocal();
    userModal.style.display = 'none';
    setProgress('Perfil salvo');
    conferirBtn.disabled = (Object.keys(nfList).length === 0) || (Object.keys(sumulaList).length === 0);
  }
});

// Abrir modal para editar perfil
editProfileBtn.addEventListener('click', ()=> {
  inputNomeModal.value = currentUser.nome || '';
  inputCargoModal.value = currentUser.cargo || '';
  inputAvatarModal.value = '';
  userModal.style.display = 'flex';
});

// Logout -> reabrir modal e limpar currentUser (mant√©m dados de confer√™ncia)
logoutBtn.addEventListener('click', ()=> {
  currentUser = { nome:'Usu√°rio', cargo:'', avatar:'https://fernanda-li.github.io/CONFERENTE_ONLINE/abelha.png' };
  userNameEl.textContent = currentUser.nome;
  userAvatarEl.src = currentUser.avatar;
  saveLocal();
  // mostra modal para novo cadastro
  inputNomeModal.value = '';
  inputCargoModal.value = '';
  inputAvatarModal.value = '';
  userModal.style.display = 'flex';
});

// Upload banco
dbUpload.addEventListener('change', async ()=> {
  if(!dbUpload.files[0]) return;
  setProgress('Lendo arquivo...');
  const items = await parseFile(dbUpload.files[0]);
  if(!items.length){ setProgress('Nenhum produto reconhecido'); return; }
  bancoProdutos = items;
  saveLocal();
  renderDatalist();
  setProgress(`Banco carregado (${bancoProdutos.length} produtos)`);
});

// adiciona produto nas listas (nf ou sumula)
function addProdutoLista(lista){
  const val = Number(quantInput.value);
  const sel = produtoInput.value.trim();
  if(!val || !sel){ alert('Selecione produto e quantidade'); return; }
  const match = bancoProdutos.find(p => sel.includes(p.nome) || sel.includes(p.codigo));
  if(!match){ alert('Produto n√£o encontrado no banco'); return; }
  lista[match.codigo] = (lista[match.codigo] || 0) + val;
  produtoInput.value = ''; quantInput.value = '';
  conferirBtn.disabled = (Object.keys(nfList).length === 0) || (Object.keys(sumulaList).length === 0);
  renderTable();
  setProgress(`Produto "${match.nome}" adicionado (total: ${lista[match.codigo]})`);
  saveLocal();
}
okNF.addEventListener('click', ()=> addProdutoLista(nfList));
okSumula.addEventListener('click', ()=> addProdutoLista(sumulaList));

// Conferir
conferirBtn.addEventListener('click', ()=> {
  renderTable(true);
  const totalNF = Object.values(nfList).reduce((a,b)=>a+b,0);
  const totalSum = Object.values(sumulaList).reduce((a,b)=>a+b,0);
  const totalDiv = Object.keys({...nfList,...sumulaList}).reduce((acc,c)=> acc + Math.abs((nfList[c]||0)-(sumulaList[c]||0)), 0);
  const itensConferidos = Object.keys({...nfList,...sumulaList}).length;
  history.unshift({
    data: new Date().toLocaleString(),
    usuario: currentUser.nome,
    totalNF,
    totalSum,
    totalDiv
  });
  renderHistory();
  saveLocal();
  setProgress(`Confer√™ncia conclu√≠da ‚Äî ${itensConferidos} itens conferidos`);
});

// Nova confer√™ncia (reseta as listas)
novaConfBtn.addEventListener('click', ()=> {
  if(!confirm('Deseja iniciar nova confer√™ncia?')) return;
  nfList = {}; sumulaList = {};
  conferirBtn.disabled = true;
  renderTable();
  setProgress('Nova confer√™ncia iniciada');
  saveLocal();
});

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// Inicializa√ß√£o ‚Äî carregar localStorage
(function init(){
  const saved = localStorage.getItem(STORAGE_KEY);
  if(saved){
    try {
      const parsed = JSON.parse(saved);
      bancoProdutos = parsed.banco || [];
      nfList = parsed.nf || {};
      sumulaList = parsed.sumula || {};
      if(parsed.currentUser) currentUser = parsed.currentUser;
      userNameEl.textContent = currentUser.nome || 'Usu√°rio';
      userAvatarEl.src = currentUser.avatar || userAvatarEl.src;
    } catch(e){
      console.warn('Erro ao ler storage', e);
    }
  } else {
    // Se n√£o tem usu√°rio salvo, for√ßar modal
    userModal.style.display = 'flex';
  }

  const savedHist = localStorage.getItem(HISTORY_KEY);
  if(savedHist){
    try { history = JSON.parse(savedHist); } catch(e){ history = []; }
  }

  renderDatalist();
  renderTable();
  renderHistory();
  conferirBtn.disabled = (Object.keys(nfList).length === 0) || (Object.keys(sumulaList).length === 0);
  setProgress(`Banco carregado (${bancoProdutos.length} produtos)`);
})();
</script>

</body>
</html>

